<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Anon Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#1f1f1f;--bg2:#444;
    --bubble-l:#323232;--bubble-r:#4e4e4e;--bubble-sys:#2a2a2a;
    --txt:#eaeaea;--accent:#ffd85c;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Heebo',sans-serif;
    height:100vh;                        /* מסגרת קבועה */
    display:flex;flex-direction:column;
    background:linear-gradient(var(--bg1),var(--bg2));
    color:var(--txt);overflow:hidden;    /* גוף לא גולל */
  }
  header{padding:.7rem;font-size:1.1rem;font-weight:700;text-align:center}
  #chat{
    flex:1;overflow-y:auto;              /* רק כאן גלילה */
    padding:.8rem .8rem 5.5rem;          /* ריפוד תחתון שלא יסתיר footer */
    display:flex;flex-direction:column;gap:.6rem
  }
  .bubble{max-width:80%;border-radius:16px;padding:.55rem .8rem;background:var(--bubble-l);
          display:flex;flex-direction:column;word-wrap:break-word;animation:fade .25s}
  .right{align-self:flex-end;background:var(--bubble-r)}
  .sys{align-self:center;background:var(--bubble-sys);max-width:90%;text-align:center;
       font-size:.8rem;color:#bbb}
  .name{font-size:.7rem;font-weight:700;margin-bottom:.15rem;color:var(--accent)}
  .body{font-size:.95rem;line-height:1.32;white-space:pre-wrap;direction:rtl}
  .meta{font-size:.6rem;margin-top:.25rem;opacity:.6;align-self:flex-end}
  footer{
    position:fixed;left:0;right:0;bottom:0;z-index:2;   /* דבוק מסך */
    display:flex;gap:.4rem;background:#0005;padding:.55rem .8rem;
    align-items:flex-end}
  textarea{
    flex:1;border:none;border-radius:16px;padding:.6rem .9rem;font-size:.95rem;
    background:#555;color:var(--txt);resize:none;min-height:2.2rem;max-height:6.5rem;
    line-height:1.3;overflow-y:auto;direction:rtl}
  footer button{background:var(--accent);border:none;border-radius:16px;
                padding:.6rem 1.1rem;color:#000;font-weight:700;cursor:pointer}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}}
  #alert{position:fixed;top:10px;left:50%;transform:translateX(-50%);
         background:#000c;padding:.55rem 1.2rem;border-radius:16px;display:none;z-index:3}
</style>
</head>
<body>

<header><span id="user"></span> • איפוס בעוד <span id="timer">02:00</span></header>
<div id="chat"></div>

<footer>
  <textarea id="input" rows="1" placeholder="כתוב הודעה..."></textarea>
  <button id="send">שלח</button>
</footer>
<div id="alert"></div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
/* ===== קוד הלוגיקה (גרסת epoch) – ללא שינוי מהפעם הקודמת ===== */
const gun  = Gun(['https://gun-manhattan.herokuapp.com/gun']);
const room = gun.get('anon-chat-msgs');
const epochRef = gun.get('anon-chat-epoch');

const me='אנונימי'+Math.floor(Math.pow(10,Math.random()*5));
const SYS_USER='אתר';
const SYS_TEXT='השימוש באתר למטרות חוקיות בלבד, משתמש שישתמש באתר למטרות לא חוקיות יורחק';
document.getElementById('user').textContent=me;

const chat=document.getElementById('chat');
const input=document.getElementById('input');
const timer=document.getElementById('timer');
const alertB=document.getElementById('alert');

const WINDOW_MS=120000; let epoch=0;

/* -- קבלת epoch נוכחי -- */
epochRef.once(d=>{epoch=(d&&d.val)|0;sub();});

/* -- טיימר & קידום epoch -- */
setInterval(()=>{
  const left=WINDOW_MS-(Date.now()%WINDOW_MS);
  timer.textContent=`${String(Math.floor(left/60000)).padStart(2,'0')}:${String(Math.floor(left/1000)%60).padStart(2,'0')}`;
  if(left<1000) epochRef.put(epoch+1,ack=>{if(!ack.err) flash('✨ הצ׳אט אופס!');});
},1000);

/* -- שינוי epoch -- */
epochRef.on(d=>{
  const newEp=(d&&d.val)|0;
  if(newEp!==epoch){epoch=newEp;chat.innerHTML='';}
});

/* -- סנכרון הודעות -- */
function sub(){room.map().on((m,id)=>{
  if(!m||!m.txt||m.ep!==epoch||document.getElementById(id))return;
  draw(m,id);
});}

function draw(m,id){
  const w=document.createElement('div');w.id=id;
  if(m.from===SYS_USER){w.className='bubble sys';w.innerHTML=`<div class="body">${m.txt}</div>`;}
  else{w.className='bubble'+(m.from===me?' right':'');
       w.innerHTML=`<div class="name">${m.from}</div><div class="body" dir="auto">${m.txt}</div>
                    <div class="meta">${new Date(m.ts).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</div>`;}
  chat.appendChild(w);chat.scrollTop=chat.scrollHeight;
}

/* -- שליחה -- */
function send(){const txt=input.value.trim();if(!txt)return;
  room.get(Gun.text.random()).put({txt,from:me,ts:Date.now(),ep:epoch});
  input.value='';input.style.height='2.2rem';
}
document.getElementById('send').onclick=send;
input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}
  autoGrow(e.target);});
function autoGrow(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,104)+'px';}

/* -- הודעת מערכת כל 30 ש׳ -- */
setInterval(()=>room.get(Gun.text.random())
 .put({txt:SYS_TEXT,from:SYS_USER,ts:Date.now(),ep:epoch}),30000);

/* -- פלאש -- */
function flash(t){alertB.textContent=t;alertB.style.display='block';
  setTimeout(()=>alertB.style.display='none',4000);}
</script>
</body>
</html>
